<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scan Patient QR - CodeCare</title>
<link rel="stylesheet" href="dashboard.css">
<script type="module" src="https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js"></script>
</head>
<body>

<header class="header">
  <div class="title-row">
    <img src="../home/logo.png" alt="CodeCare Logo">
    <h1>CodeCare<sub>Your Health, Just a Scan Away</sub></h1>
  </div>
  <nav class="nav-links">
    <a href="../home/home.html">Home</a>
  </nav>
</header>

<main class="content">
  <div class="qr-scanner-container">
    <h3>Scan Patient QR Code</h3>
    <video id="preview" width="300" height="300"></video>
    <div class="qr-options">
      <button id="cameraBtn">📷 Use Camera</button>
      <button id="uploadBtn">📁 Upload QR Image</button>
      <input type="file" id="qrFileInput" accept="image/*" style="display:none;">
    </div>
  </div>
</main>

<script type="module">
import QrScanner from "https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js";

const video = document.getElementById('preview');
const fileInput = document.getElementById('qrFileInput');
const cameraBtn = document.getElementById('cameraBtn');
const uploadBtn = document.getElementById('uploadBtn');
const API_BASE = "https://project-production-65f9.up.railway.app/api";

let cameraActive = false;

const qrScanner = new QrScanner(video, result => handleQRData(result.data.trim()));

// Camera toggle
cameraBtn.addEventListener('click', async () => {
  if (!cameraActive) {
    await qrScanner.start();
    cameraActive = true;
    cameraBtn.textContent = "🚫 Stop Camera";
  } else {
    qrScanner.stop();
    cameraActive = false;
    cameraBtn.textContent = "📷 Use Camera";
  }
});

// Upload image
uploadBtn.addEventListener('click', () => {
  if (cameraActive) qrScanner.stop();
  fileInput.click();
});

fileInput.addEventListener('change', async () => {
  if (fileInput.files.length > 0) {
    try {
      const result = await QrScanner.scanImage(fileInput.files[0]);
      handleQRData(result.data.trim());
    } catch (err) {
      alert('Failed to read QR code: ' + err.message);
    }
  }
});

// Handle QR: fetch latest patient info
function handleQRData(email) {
  fetch(`${API_BASE}/user/${encodeURIComponent(email)}`)
    .then(res => res.ok ? res.json() : Promise.reject('Patient not found'))
    .then(data => {
      localStorage.setItem('patientData', JSON.stringify(data));
      window.location.href = "patientDashboard.html";
    })
    .catch(err => {
      alert(err);
      console.error(err);
    });
}
</script>
</body>
</html>
